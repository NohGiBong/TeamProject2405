<!DOCTYPE HTML>

<!--
	Helios by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <title>Cinemacast</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/assets/css/main.css" />
    <link rel="stylesheet" href="/assets/css/custom.css" />
    <link rel="stylesheet" href="/assets/css/nav.css" />
    <noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript>

<!--    댓글-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
</head>
<body class="right-sidebar is-preload">
<div id="page-wrapper">

    <header data-include-path="./header.html"></header>

    <!-- Main -->
    <div class="wrapper style1">

        <div class="container" th:each="movie, iterStat : ${movieInfos}">
            <input type="hidden" id="movieId" th:value="${movie.id}">
            <div class="row gtr-200">
                <div class="col-8 col-12-mobile" id="content">
                    <article id="main">
                        <header>
                            <h2><a href="#">Movie Title</a></h2>
                            <p th:text="${movie.title}"></p>
                        </header>
                        <div id="get_header">
                            <a href="#" class="image featured" style="width: 40%;"><img src="/images/movieposter.webp" alt="영화포스터" /></a>
                            <div class="movie_info">
                                <p><b>개봉일자 : </b> <span th:text="${movie.releaseDate}">releasedate</span></p>
                                <p><b>장르 : </b> <span th:text="${movie.genres}">genres</span></p>
                                <p><b>상영시간 : </b> <span th:text="${movie.runtime} + '분'">runtime</span></p>
                                <p><b>감독 : </b>director <b>각본 : </b>writer</p>

                                <div class="movie_data_box">
                                    <div class="movie_data">
                                        <h4>누적 관객수</h4>
                                        <p>cnv</p>
                                    </div>
                                    <div class="movie_data">
                                        <h4>인기도</h4>
                                        <p th:text="${movie.popularity}">popularity (%)</p>
                                    </div>
                                    <div class="movie_data">
                                        <h4>평점</h4>
                                        <p th:text="${movie.voteAverage}">vote rating</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div id="movie-info"></div>
                        <p th:text="${movie.overview}">
                            ~ overview ~
                        </p>
                    </article>
                </div>
                <div class="col-4 col-12-mobile" id="sidebar">
                    <hr class="first" />
                    <section>
                        <header>
                            <h3><a href="#">Sed lorem etiam consequat</a></h3>
                        </header>
                        <div class="row gtr-50">
                            <div class="col-4">
                                <a href="#" class="image fit"><img src="/images/pic10.jpg" alt="" /></a>
                            </div>
                            <div class="col-8">
                                <h4>Nibh sed cubilia</h4>
                                <p>
                                    Amet nullam fringilla nibh nulla convallis tique ante proin.
                                </p>
                            </div>
                            <div class="col-4">
                                <a href="#" class="image fit"><img src="/images/pic11.jpg" alt="" /></a>
                            </div>
                            <div class="col-8">
                                <h4>Proin sed adipiscing</h4>
                                <p>
                                    Amet nullam fringilla nibh nulla convallis tique ante proin.
                                </p>
                            </div>
                            <div class="col-4">
                                <a href="#" class="image fit"><img src="/images/pic12.jpg" alt="" /></a>
                            </div>
                            <div class="col-8">
                                <h4>Lorem feugiat magna</h4>
                                <p>
                                    Amet nullam fringilla nibh nulla convallis tique ante proin.
                                </p>
                            </div>
                            <div class="col-4">
                                <a href="#" class="image fit"><img src="/images/pic13.jpg" alt="" /></a>
                            </div>
                            <div class="col-8">
                                <h4>Sed tempus fringilla</h4>
                                <p>
                                    Amet nullam fringilla nibh nulla convallis tique ante proin.
                                </p>
                            </div>
                            <div class="col-4">
                                <a href="#" class="image fit"><img src="/images/pic14.jpg" alt="" /></a>
                            </div>
                            <div class="col-8">
                                <h4>Malesuada fermentum</h4>
                                <p>
                                    Amet nullam fringilla nibh nulla convallis tique ante proin.
                                </p>
                            </div>
                        </div>
                        <footer>
                            <a href="#" class="button">Magna Adipiscing</a>
                        </footer>
                    </section>
                </div>
            </div>
            <div id="stillcut" th:each="movie, iterStat : ${movieInfos}">
                <hr />
                <h2>StillCut</h2>
                <div class="row">
                    <article class="col-4 col-12-mobile special">
                        <a href="#" class="image featured">
                            <img th:src="@{'https://image.tmdb.org/t/p/w780' + ${movie.stillCutPaths}}" alt="스틸컷" />
                        </a>
                    </article>
                    <article class="col-4 col-12-mobile special">
                        <a href="#" class="image featured"><img src="/images/pic08.jpg" alt="" /></a>
                    </article>
                    <article class="col-4 col-12-mobile special">
                        <a href="#" class="image featured"><img src="/images/pic09.jpg" alt="" /></a>
                    </article>
                </div>
            </div>
        </div>

    </div>

    <div class="container">
        <h2>댓글</h2>
        <div id="comments"></div>
        <button id="addCommentBtn" class="btn btn-primary">댓글 추가하기</button>
    </div>

    <!-- 댓글 추가 모달 -->
    <div id="info" th:data-username="${#authentication.name}">
        <ul>
            <li sec:authorize="hasRole('USER')"><span sec:authentication="name"></span> 님 환영합니다.<li>
            <li sec:authorize="isAnonymous()">
                <a href="/member/new">회원가입</a>
            </li>
            <li sec:authorize="isAnonymous()">
                <a href="/member/login">로그인</a>
            </li>
            <li sec:authorize="isAuthenticated()">
                <a href="/member/logout">로그아웃</a>
            </li>
            <li><a href="#">장바구니</a></li>
        </ul>
    </div>
    <div class="modal" id="commentModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">댓글 추가</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="commentForm">
<!--                        <div class="form-group">-->
<!--                            <label for="userId">작성자 ID:</label>-->
<!--                            <input type="text" class="form-control" id="userId">-->
<!--                        </div>-->
                        <div class="form-group">
                            <label for="commentText">댓글:</label>
                            <textarea class="form-control" id="commentText"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="rating">평점:</label>
                            <select class="form-control" id="rating">
                                <option>1</option>
                                <option>2</option>
                                <option>3</option>
                                <option>4</option>
                                <option>5</option>
                            </select>
                        </div>
<!--                        <div class="form-group">-->
<!--                            <label for="postNumber">영화 게시글 번호:</label>-->
<!--                            <input type="text" class="form-control" id="postNumber">-->
<!--                        </div>-->

                        <button type="submit" class="btn btn-primary">댓글 작성</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <footer data-include-path="footer.html"></footer>
</div>

<!-- Scripts -->
<script src="/static/assets/js/jquery.min.js"></script>
<script src="/static/assets/js/jquery.dropotron.min.js"></script>
<script src="/static/assets/js/jquery.scrolly.min.js"></script>
<script src="/static/assets/js/jquery.scrollex.min.js"></script>
<script src="/static/assets/js/browser.min.js"></script>
<script src="/static/assets/js/breakpoints.min.js"></script>
<script src="/static/assets/js/util.js"></script>
<script src="/static/assets/js/main.js"></script>



<!--              댓글         ------------------             -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<script src="app.js"></script>

<script>
    // include.js
    window.addEventListener('load', function() {
        var allElements = document.getElementsByTagName('*');
        Array.prototype.forEach.call(allElements, function (el) {
            var includePath = el.dataset.includePath;
            if (includePath) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        el.outerHTML = this.responseText;
                    }
                };
                xhttp.open('GET', includePath, true);
                xhttp.send();
            }
        });
    });

    const options = {
        method: 'GET',
        headers: {
            accept: 'application/json',
            Authorization: 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI3N2UzMWU5NWVjZmE3ZjBlODY5YTE3NmQwMjU0YWQwMiIsInN1YiI6IjY2NDJiMWM1ZTJlZjM4N2Y1MjM1OTNjZCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.hBVsW7eVrC2M3FdWc2OJEAWq0h4v-NiiM2YEDQoy7OU'
        }
    };

    async function fetchMovieCredits() {
        try {
            const response = await fetch('https://api.themoviedb.org/3/movie/1011985/credits?language=ko-KR', options);
            const data = await response.json();

            // 영화 정보를 담을 요소 생성
            const movieInfoDiv = document.getElementById('movie-info');
            movieInfoDiv.style.display = 'flex'; // Flexbox 레이아웃 적용
            movieInfoDiv.style.flexWrap = 'wrap'; // 요소들이 넘치면 다음 줄로 넘김

            // 출연진 정보 출력 (이미지 포함)
            data.cast.slice(0, 5).forEach(cast => {
                const castDiv = createPersonDiv(cast.name, cast.profile_path);
                movieInfoDiv.appendChild(castDiv); // castDiv를 movieInfoDiv에 추가
            });

            // 감독 정보 출력 (이미지 포함)
            const director = data.crew.find(person => person.job === 'Director');
            if (director) {
                const directorDiv = createPersonDiv(director.name, director.profile_path, true);
                movieInfoDiv.appendChild(directorDiv); // directorDiv를 movieInfoDiv에 추가
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // 인물 정보와 이미지를 담은 div 생성 함수
    function createPersonDiv(name, profilePath, isDirector = false) {
        const personDiv = document.createElement('div'); // 새로운 div 생성
        personDiv.style.margin = '5px'; // 간격 설정

        const p = document.createElement('p');
        p.innerHTML = isDirector ? `<b>감독 : </b>${name}` : name;
        p.style.fontSize = '15px'; // 글자 크기 작게 설정

        const img = document.createElement('img');
        img.src = `https://image.tmdb.org/t/p/w200${profilePath}`; // 이미지 경로 설정
        img.alt = `${name}'s profile image`;
        img.style.width = '40px';
        img.style.height = 'auto'; // 높이를 자동으로 설정

        personDiv.appendChild(p);
        personDiv.appendChild(img);

        return personDiv;
    }

    fetchMovieCredits();

    const api = {
        method: 'GET',
        headers: {
            accept: 'application/json',
            Authorization: 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI3N2UzMWU5NWVjZmE3ZjBlODY5YTE3NmQwMjU0YWQwMiIsInN1YiI6IjY2NDJiMWM1ZTJlZjM4N2Y1MjM1OTNjZCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.hBVsW7eVrC2M3FdWc2OJEAWq0h4v-NiiM2YEDQoy7OU'
        }
    };

//                                  댓글       --------------------------------------------------
    $(document).ready(function() {
        // 환경 설정: 필요한 변수 선언
        const movieId = $('#movieId').val();
        const memberId = $('#info').data('username');

        // 댓글을 로드하는 함수 정의
        const loadComments = () => {
            $.ajax({
                url: `/movies/${movieId}`,
                method: 'GET',
                dataType: 'json',
                success: (data) => {
                    const commentsContainer = $('#comments').empty();
                    data.forEach(({memberId, movieId, comment, grade}) => {
                        commentsContainer.append(
                            `<div class="comment">
                            <p>작성자 ID: ${memberId}</p>
                            <p>영화번호 : ${movieId}</p>
                            <p>댓글: ${comment}</p>
                            <p>평점: ${grade}</p>
                        </div>`
                        );
                    });
                },
                error: (xhr, status, error) => {
                    console.error("댓글을 불러오지 못했습니다:", error);
                    $('#comments').append(
                        `<div class="error">
                        <p>댓글을 불러오는 중 오류가 발생했습니다. 나중에 다시 시도해주세요.</p>
                    </div>`
                    );
                }
            });
        };

        // 모달을 보여주는 이벤트 핸들러
        $('#addCommentBtn').click(() => $('#commentModal').modal('show'));

        // 댓글 제출 이벤트 핸들러
        $('#commentForm').submit(function(e) {
            e.preventDefault();

            // 댓글 데이터를 수집하는 부분은 submit 이벤트 내부로 이동
            const comment = $('#commentText').val();
            const grade = $('#rating').val();

            const commentData = JSON.stringify({
                memberId: memberId,
                comment: comment,
                grade: grade,
                movieId: movieId
            });

            console.log(commentData);

            $.ajax({
                url: '/new',
                method: 'POST',
                contentType: 'application/json',
                data: commentData,
                success: () => {
                    $('#commentModal').modal('hide');
                    loadComments();
                }
            });
        });

        // 초기 댓글 로드
        loadComments();
    });

</script>
</body>
</html>